# 项目推进计划（galileo）

## 关键信息整理
- 项目目标：构建面向套利场景的自托管 Jupiter 机器人，需管理二进制生命周期、提供高性能 HTTP quote/swap 服务，并具备详尽的耗时记录能力（用户需求 1/2/3）。
- 参考资料：`docs/` 下的 `jupiter_self_host.md`、`quote.md`、`swap.md` 描述 Jupiter API 原理与调用方式；`README.md` 汇总高性能实践与技术选型。
- 现有能力：`src/jupiter/manager.rs` 已实现下载、更新、启动、停止逻辑；`src/jupiter/client/http.rs` 能发起 quote/swap 请求并记录延迟；`src/metrics/` 提供通用耗时埋点。
- 外部参考：`third_party/run-jup.sh`、`third_party/config.yaml.example` 汇总了成熟套利系统的 Jupiter 启动参数（端口/host、线程数、`--allow-circular-arbitrage`、`--enable-new-dexes`、`--filter-markets-with-mints` 等）与代币筛选流程，可作为自托管实例的配置蓝本。

## 阶段规划
### 阶段 0：现状确认与环境准备
- [x] 核对 `galileo.toml`（或默认配置）是否满足当前部署需求，补充缺失项。
- [x] 运行 `cargo check`/`cargo test` 与冒烟调用，确认基础功能可用。
- [ ] 明确部署环境：运行目录、Jupiter 二进制安装路径、日志存储策略。
- [x] 提炼 `third_party/config.yaml.example` 中 Jupiter 相关配置，形成默认模板或文档条目，方便后续按需启用。

### 阶段 1：二进制生命周期强化（需求 1）
- [x] 完善 `JupiterBinaryManager` 状态机：补齐异常退出检测、自动重启策略与状态上报。
- [ ] 实现二进制版本锁定/回滚策略（例如通过版本缓存与校验摘要）。
- [x] 根据 `third_party/run-jup.sh` 整理出的常用启动参数，扩展 `JupiterConfig` 或预置参数生成逻辑（端口、host、线程数、DEX 过滤、Yellowstone 认证等），减少手动拼接 `args` 的负担。
- 交付物：增强后的生命周期管理模块、操作说明文档。

### 阶段 2：高性能路径优化（需求 2）
- [ ] 基于 `README.md` 的高性能建议，评估现有异步/并发模型，给出热点路径的改进设计（如 `quote` 批处理、Rayon 线程池使用场景）。
- [ ] 优化 HTTP 层：连接池、重试/超时策略、并发控制、失败快速切换（fallback RPC）。
- [ ] 设计缓存层（DashMap/Moka）以降低重复请求成本，并规划持久化策略（Sled 可选）。
- [ ] 建立性能基线：制定 QPS、P95/P99 延迟指标与压测脚本。
- 交付物：性能优化方案与实现、压测报告。

### 阶段 3：可观测性与耗时追踪（需求 3）
- [ ] 细化 `metrics` 模块：按阶段记录 quote、swap、下载、健康检查等耗时；输出至日志 & 指标系统（Prometheus/OpenTelemetry 选型）。
- [ ] 构建日志规范：结构化字段（trace_id、route、slot、金额），区分业务/性能日志，规划日志轮转与集中收集。
- [ ] 增加关键操作的事件追踪（如套利决策、交易发送、落地结果），确保能复盘每次套利流程。
- [ ] 如果有外部监控接入需求，提供导出适配层。
- 交付物：完善的监控/日志实现与可观测性使用手册。

### 阶段 4：套利业务工作流打磨
- [ ] 结合 `docs/demo.md` 与 `third_party/mints-query.sh` 的实践，实现策略引擎框架：周期性抓取 quote、计算收益、生成 swap 请求，并支持代币白名单/排除机制。（初版循环已落地，待接入代币白名单与发送路径）
- [ ] 引入风险控制（滑点阈值、资金管理、失败重试/暂停机制）。
- [ ] 集成发送路径（Jito/自建 relayer），记录交易成功率与收益统计。
- 交付物：策略执行模块、配置化参数、收益/风险报表。

### 阶段 5：运维与部署
- [ ] 制定部署说明：服务依赖、环境变量、系统服务（systemd/docker）配置。
- [ ] 规划灰度/回滚流程，编写巡检脚本。
- [ ] 输出 SLO/SLA 目标与告警策略。
- 交付物：部署手册、运维脚本、告警配置。

## 配置与文档工作
- 持续更新 `docs/`，新增：
  - 生命周期操作手册
  - 性能优化指南
  - 监控指标说明
  - 套利策略参考
  - Jupiter 启动参数参考（已新增 `docs/jupiter_launch_params.md`，后续保持同步）
- 维护 `plan.md`，每完成阶段更新状态与里程碑。

## 里程碑与验收
1. **M1**：生命周期管理稳定（阶段 1 完成），具备稳定运行能力。
2. **M2**：性能目标达标，提供压测数据（阶段 2 完成）。
3. **M3**：监控闭环与日志追踪建立（阶段 3 完成）。
4. **M4**：套利策略上线并可持续运行（阶段 4 完成）。
5. **M5**：部署与运维体系落地（阶段 5 完成）。

## 合作方式
- 每个阶段启动前评审设计方案，阶段结束进行成果验收与文档更新。
- 需要额外信息（RPC 节点、Jito 配置、日志系统等）时提前同步。
- 保持 `plan.md` 与实现进度同步，确保后续迭代可追踪。
