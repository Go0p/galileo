# Galileo 开发者工作守则

> 本文规定日常开发的行为准则，约束 trait + 泛型 架构的延续性，并确保策略引擎在高性能、可观测的前提下迭代。

## 1. 使命与责任
- 保持套利链路端到端低延迟，所有改动需评估对 Quote → Swap → 落地 的耗时影响。
- 任何新模块必须遵循零成本抽象原则，优先使用 trait + 泛型；除非经评估，禁止引入 `Box<dyn>` 等动态分发到关键路径。
- 监控事件不可缺失，一旦出现新流程，需在关键节点补充 metrics / tracing / logging。

## 2. 目录与模块规范
- `src/engine/`：调度、交易构建、落地前处理；不允许嵌入策略特定逻辑。
- `src/strategy/`：单一策略一个文件，命名沿用策略名（如 `spam.rs`, `blind.rs`）。`mod.rs` 仅负责 re-export。
- `src/lander/`：统一 `Lander` trait，所有上链实现不可直接依赖策略模块。
- `monitoring`、`config`、`types` 等共享逻辑保持纯粹，禁止夹带业务逻辑或 IO。
- 若需新目录，必须在 PR 中解释它在分层体系中的位置。

## 3. 开发准则
- **性能优先**：在 tokio 上游保持异步 IO；计算密集部分交给 rayon；队列操作默认 `try_send`。
- **无缓存原则**：对 Jupiter Quote 不做缓存；如需缓存其他数据，阐明过期策略与命中率。
- **配置驱动**：所有可调节参数必须来自配置文件，代码中不得写死魔法数字。
- **观测覆盖**：新增逻辑需附带 metrics 名称、标签，并在文档或 PR 描述监控用途。
- **Prometheus 输出**：如需线上监控，在 `galileo.yaml` 的 `bot.prometheus` 中开启 `enable` 并指定监听地址；新增指标请在 `monitoring::events` 中补充 `metrics` 打点，同时更新文档说明采集/看板用途。
- **错误处理**：分清可重试/不可重试错误；不可重试场景需要落盘或打点，供排障使用。
- **性能分析**：关键路径函数或代码块应使用 `cfg_attr(feature = "hotpath", hotpath::measure)` / `hotpath::measure_block!` 标注；新增模块记得在文档中说明如何开启 `cargo run --features=hotpath`，便于后续快速定位瓶颈。

## 4. 测试与验证
- 引擎与策略新增功能须至少覆盖单元测试或集成测试；涉及多线程的逻辑使用 `#[tokio::test(flavor = "multi_thread")]` 或 rayon 安全测试。
- Quote / Swap API 行为尽量使用本地 Jupiter 仿真；上线前确保 `galileo strategy` 在 dry-run 下运行成功。
- 性能敏感改动需提供基准数据（例如 Quote 延迟分布、落地成功率）并写入 PR 描述。

## 5. 监控与告警
- 任何对 Quote、Swap、Lander 流程的改动，需同步更新 `monitoring` 模块和指标列表。
- 若新增指标，需在文档中说明含义、标签维度、预期阈值。必要时更新仪表盘。
- 对落地失败率、利润分布、Blockhash freshness 等关键指标建立告警阈值。

## 6. 变更流程
- 提交 PR 前请更新相关文档（例如 `docs/strategy_arch.md` 或配置参考），确保文档与代码保持一致。
- 对落地器、策略调度、监控指标的重大变更需先发设计提案，获得团队评审后实施。
- 与第三方依赖（Jito、Jupiter 等）交互方式变化时，立即同步团队并标注兼容性风险。

## 7. 责任追踪
- 代码中添加新策略、新落地器时，请在文件头部注明维护者。
- 线上出现故障需在 24 小时内补充回溯记录与改进措施，归档到 `docs/postmortem/`（若文件夹不存在请创建）。

> 按照本守则执行，可确保 Galileo 在保持高性能的同时快速迭代，策略与引擎团队既能独立演进，也能共享统一的规范与工具链。
